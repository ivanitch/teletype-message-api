# –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ ü§î

> **–î–∞–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –ù–ï —è–≤–ª—è—é—Ç—Å—è "–∏—Å—Ç–∏–Ω–æ–π –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∏"**, —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –º–æ–∏ —Å–∫—Ä–æ–º–Ω—ã–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–Ω–∏–µ –≤—Å–µ–π –∫–∞—Ä—Ç–∏–Ω—ã –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–≥–æ.
>
> –†–µ—à–µ–Ω–∏—è –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ—Ö –∏–ª–∏ –∏–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –∫–æ–ª–ª–µ–≥–∏–∞–ª—å–Ω–æ –≤—Å–µ–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–æ–ª–≥–∏—Ö –æ–±—Å—É–∂–¥–µ–Ω–∏–π.  

## –ü—Ä–æ–±–ª–µ–º—ã
- –ü—Ä–æ–±–ª–µ–º–∞ –≥–æ–Ω–∫–∏/–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (race condition), –∏–∑-–∑–∞ —á–µ–≥–æ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—Ç `1` —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç –¥–∏–∞–ª–æ–≥ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ –ø—Ä–∏—à–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –∏ **_—Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏_**.
- –ü—Ä–æ–±–ª–µ–º—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç —Å –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é (`–æ—Ç 1k RPS`), –≤—Å—ë –¥–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –±–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω–æ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ `10–ö RPS`. 

## –ó–∞–¥–∞—á–∏
- –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, —É–∫–∞–∑–∞–Ω—ã–µ –≤—ã—à–µ.
- –û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–∞–≥—Ä—É–∑–∫–∏.
- –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î –∏ –∏–Ω–¥–µ–∫—Å–æ–≤.
- –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è, —á—Ç–æ-—Ç–æ –µ—â—ë).

| –ó–∞–¥–∞—á–∞                              | –†–µ—à–µ–Ω–∏–µ                                        | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å  ‚úÖ |
| ----------------------------------- | ---------------------------------------------- | ------------- |
| [–ì–æ–Ω–∫–∞ –∑–∞ –¥–∏–∞–ª–æ–≥](#–≥–æ–Ω–∫–∞-–∑–∞-–¥–∏–∞–ª–æ–≥) | Redis-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ [Mutex], –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã   | ‚úÖ             |
| [–ù–∞–≥—Ä—É–∑–∫–∞ >1k RPS](#–Ω–∞–≥—Ä—É–∑–∫–∞)       | –û—á–µ—Ä–µ–¥—å + –≤–æ—Ä–∫–µ—Ä—ã                              | ‚úÖ ü§î          |
| –î—É–±–ª–∏–∫–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π                 | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞     | ‚úÖ             |
| –¢–µ—Å—Ç—ã                               | PHPUnit, ~~–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ~~          | ‚úÖ ü§î          |
| –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ / —Ä–æ—Å—Ç —Å–∏—Å—Ç–µ–º—ã         | –ü–æ —Ö–µ—à—É `client_id` / –ø–æ —Ä–µ–≥–∏–æ–Ω—É               | + DevOps      |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã                 | Prometheus, Grafana, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å UID –∑–∞–ø—Ä–æ—Å–∞ | + DevOps      |

## üí° –ì–æ–Ω–∫–∞ –∑–∞ –¥–∏–∞–ª–æ–≥ 

### –ò–Ω–¥–µ–∫—Å—ã

–ß—Ç–æ–±—ã –ë–î —Å–∞–º–∞ –ø–æ–º–æ–≥–∞–ª–∞ –∏–∑–±–µ–≥–∞—Ç—å –¥—É–±–ª–µ–π, –≤–≤–µ–¥–µ–Ω—ã —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:

- `clients` 
  - **–ò–Ω–¥–µ–∫—Å:** `unique-client` –ø–æ (`external_client_id`, `client_phone`)
  - **–ó–∞—á–µ–º:** –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö. –ú—ã —Ä–∞–∑–ª–∏—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–º–µ–Ω–Ω–æ –ø–æ —Å–≤—è–∑–∫–µ `–≤–Ω–µ—à–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ + –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞`.
    –¢–æ –µ—Å—Ç—å, –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:
```bash
# –ö–ª–∏–µ–Ω—Ç
external_client_id='client00000000000000000000000000'
client_phone='+70000000000'
# –∏ 
external_client_id='client00000000000000000000000001'
client_phone='+70000000000'
# –¥–æ–ª–∂–Ω—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î —Å –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
```

- `dialogs`
  - **–ò–Ω–¥–µ–∫—Å:** `unique-dialog-client`. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –∫–ª–∏–µ–Ω—Ç—É (`–æ–¥–∏–Ω –ö–ª–∏–µ–Ω—Ç ‚Äî –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –î–∏–∞–ª–æ–≥`).
  - **–ó–∞—á–µ–º:** –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ webhook-—Å–æ–±—ã—Ç–∏—è).


- `messages` —Å–æ—Å—Ç–∞–≤–Ω–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `unique-client-dialog-message`. –°–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ö–ª–∏–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º –î–∏–∞–ª–æ–≥–µ. –¢–∞–∫–æ–π –Ω–¥–µ–∫—Å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –µ–≥–æ –¥–∏–∞–ª–æ–≥–∞.


### Redis-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ [Mutex]
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `\src\services\MessageService::process`

–ú–µ—Ç–æ–¥ `process()` ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –í –Ω—ë–º:
1. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–ª—é—á –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (`idempotent:msg:{client_id}:{message_id}`) ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
2. –°—Ç–∞–≤–∏—Ç—Å—è Redis-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (mutex) –ø–æ –∫–ª–∏–µ–Ω—Ç—É.
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø–æ Redis –∫–ª—é—á—É).
4. –ï—Å–ª–∏ –≤—Å—ë –æ–∫:
   - —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ö–ª–∏–µ–Ω—Ç;
   - —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –î–∏–∞–ª–æ–≥ –∫–ª–∏–µ–Ω—Ç–∞ (—á–µ—Ä–µ–∑ Redis Mutex –≤–Ω—É—Ç—Ä–∏);
   - —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –°–æ–æ–±—â–µ–Ω–∏–µ;
   - –≤ Redis –ø–∏—à–µ—Ç—Å—è –∫–ª—é—á –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ 1 —á–∞—Å (`setex`).
5. –ü—Ä–∏ –ª—é–±–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ ‚Äî –æ—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –ª–æ–≥.


> **–ß—Ç–æ –µ—â—ë –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:**
> - –í –ø–∞–∫–µ—Ç `yiisoft/yii2-redis` —É–∂–µ –≤–∫–ª—é—á—ë–Ω –º–µ—Ö–∞–Ω–∏–∑–º [Mutex](https://github.com/yiisoft/yii2-redis/blob/master/src/Mutex.php)
> - [Redis + Lua](https://redis.io/docs/latest/develop/interact/programmability/eval-intro/) –∏ [https://redis.io/docs/latest/develop/use/patterns/distributed-locks/](https://redis.io/docs/latest/develop/use/patterns/distributed-locks/)
> - –ï—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç (–¥–ª—è Yii3) [mutex-redis](https://github.com/yiisoft/mutex-redis) 
> - –ò–º–µ–µ—Ç—Å—è —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ-–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–∞–∫–µ—Ç [malkusch/lock](https://packagist.org/packages/malkusch/lock), –±–æ–ª–µ–µ 8–ú —É—Å—Ç–∞–Ω–æ–≤–æ–∫
> - –í Symfony –µ—Å—Ç—å —Ç–∞–∫–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç [https://symfony.com/doc/current/components/lock.html](https://symfony.com/doc/current/components/lock.html)



## üí° –ù–∞–≥—Ä—É–∑–∫–∞  

–ù–∞ —á—Ç–æ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å: üëÄ
- [Redis Queue –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π](https://redis.io/glossary/redis-queue/)
- [RabbitMQ –¥–ª—è –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π](https://www.rabbitmq.com/)
- Nginx + [OpenResty](https://openresty.org/en/): –°—Ç–∞—Ç—å—è –ø–æ —Ç–µ–º–µ: [OpenResty: –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º NGINX –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π](https://habr.com/ru/articles/321864/)



## –¢–µ—Å—Ç—ã

–°–∫—Ä–∏–ø—Ç `/.loadtester/test.php` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –æ—Ç –æ–±—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.
- –ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- –î—É–±–ª–∏ –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (~ 90% –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, ~ 5% –¥—É–±–ª–µ–π, ~ 5% –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö)
- –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –Ω–æ–º–µ—Ä —É —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞:
```bash
docker exec -it teletype_loadtester php /app/test.php

# –∏–ª–∏
make tester
```
